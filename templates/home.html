<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VisionAI | Home Dashboard</title>

  <!-- Bootstrap & Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Icons -->
  <link rel="icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <!-- ‚úÖ PWA: Manifest + Service Worker -->
  <link rel="manifest" href="/manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service_worker.js')
        .then(() => console.log('‚úÖ VisionAI Service Worker Registered'))
        .catch(err => console.log('‚ùå Service Worker Failed:', err));
    }
  </script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at 20% 20%, #00132c, #000814);
      color: #fff;
      overflow-x: hidden;
    }
    .navbar {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .navbar-brand img { height: 45px; margin-right: 10px; animation: float 4s ease-in-out infinite; }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-4px);} }
    h3 { color:#00b4d8; text-shadow:0 0 8px rgba(0,180,216,0.5); }
    .stat-card {
      background:linear-gradient(145deg,rgba(0,119,182,0.15),rgba(0,180,216,0.05));
      border:1px solid rgba(0,180,216,0.15);
      border-radius:16px; text-align:center; padding:1.5rem;
      transition:all .3s ease; box-shadow:0 5px 25px rgba(0,0,0,0.25); animation:fadeInUp 1s ease both;
    }
    .stat-card:hover {
      transform:translateY(-5px); box-shadow:0 8px 28px rgba(0,180,216,0.3);
      background:linear-gradient(145deg,rgba(0,180,216,0.25),rgba(0,119,182,0.15));
    }
    .stat-card h2 { color:#00b4d8; font-weight:800; font-size:2.2rem; margin-bottom:.4rem; }
    .stat-card p { color:#cbeaff; margin:0; font-size:.9rem; }
    .card {
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:14px; color:#fff; text-align:center;
      padding:1.5rem; transition:transform .3s ease, background .3s ease;
    }
    .card:hover { background:rgba(255,255,255,0.12); transform:translateY(-6px); }
    footer {
      text-align:center; padding:1rem; color:#aaa;
      background:rgba(255,255,255,0.03);
      border-top:1px solid rgba(255,255,255,0.05);
      margin-top:2rem; font-size:.9rem;
    }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }
    .btn-glow {
      background:linear-gradient(45deg,#00b4d8,#0077b6);
      border:none; color:#fff; border-radius:10px; padding:.6rem 1.2rem;
      font-weight:600; box-shadow:0 0 10px rgba(0,180,216,0.4); transition:all .3s ease;
    }
    .btn-glow:hover { box-shadow:0 0 18px rgba(0,180,216,0.7); transform:scale(1.05); }

    /* ‚úÖ Install Card Animation */
    #install-card {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      text-align:center; margin:40px auto;
      background:rgba(255,255,255,0.07);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:16px; padding:2rem; max-width:480px;
      color:#d2f0ff; box-shadow:0 8px 25px rgba(0,180,216,0.2);
      transition: all .6s ease;
    }
    #install-card.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    #install-card h4 { color:#00b4d8; margin-bottom:0.5rem; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
        <img src="{{ url_for('static', filename='visionai_logo.png') }}" alt="VisionAI Logo">
        <span class="fw-bold text-info">VisionAI</span>
      </a>
      <div>
        <a href="{{ url_for('upload_page') }}" class="btn btn-glow btn-sm me-2">New Screening</a>
        <a href="{{ url_for('history') }}" class="btn btn-outline-light btn-sm">History</a>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container py-5">
    <h3 class="mb-4">üè• VisionAI Dashboard ‚Äî Intelligent Retinal Screening</h3>

    <!-- Stats Section -->
    <div class="row g-4 mb-4">
      <div class="col-md-3"><div class="stat-card"><h2>{{ stats.total_patients }}</h2><p>Total Screenings</p></div></div>
      <div class="col-md-3"><div class="stat-card"><h2>{{ stats.today_patients }}</h2><p>Today‚Äôs Patients</p></div></div>
      <div class="col-md-3"><div class="stat-card"><h2>{{ stats.avg_confidence|round(1) }}%</h2><p>Avg Confidence</p></div></div>
      <div class="col-md-3"><div class="stat-card"><h2>{{ stats.avg_risk|round(1) }}</h2><p>Avg Risk Score</p></div></div>
    </div>

    <!-- Quick Navigation -->
    <div class="row g-4">
      <div class="col-md-3"><a href="{{ url_for('upload_page') }}" class="text-decoration-none"><div class="card"><h5>üì∏ New Screening</h5><p>Capture or upload a fundus image.</p></div></a></div>
      <div class="col-md-3"><a href="{{ url_for('history') }}" class="text-decoration-none"><div class="card"><h5>üßæ Patient History</h5><p>Access saved patient reports.</p></div></a></div>
      <div class="col-md-3"><a href="{{ url_for('doctor_dashboard') }}" class="text-decoration-none"><div class="card"><h5>üìä Doctor Dashboard</h5><p>View AI performance & risk trends.</p></div></a></div>
      <div class="col-md-3"><a href="{{ url_for('logs_page') }}" class="text-decoration-none"><div class="card"><h5>üß† System Logs</h5><p>Model & system performance insights.</p></div></a></div>
    </div>

    <!-- Chart Section -->
    <div class="card mt-5 p-4">
      <h5 class="text-info mb-3">üìà Model Health Overview</h5>
      <canvas id="healthChart"></canvas>
    </div>

    <!-- ‚úÖ PWA Install Card -->
    <div id="install-card">
      <img src="{{ url_for('static', filename='visionai_logo.png') }}" alt="VisionAI Logo" style="height:70px;margin-bottom:10px;">
      <h4>üì± Install VisionAI App</h4>
      <p>Install VisionAI on your device for offline access and instant retinal screening.</p>
      <button id="install-btn" class="btn btn-glow mt-2">Install VisionAI</button>
    </div>

    <!-- ‚ÑπÔ∏è About VisionAI -->
    <div class="card mt-5 p-4 text-center" style="background:rgba(255,255,255,0.05);">
      <h4 class="text-info mb-2">üåç About VisionAI</h4>
      <p class="text-light mb-2">
        VisionAI is an AI-driven retinal screening platform designed for early detection of diabetic retinopathy. 
        It integrates deep learning with explainable AI (GradCAM, LIME, SHAP) and patient metadata for clinical insights.
      </p>
      <p style="color:#aee0ff;">
        Once installed, VisionAI works offline, generates full PDF reports (Patient, Doctor, and Research), 
        and supports real-time fundus image analysis directly from your device.
      </p>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    ¬© 2025 VisionAI ‚Äî AI-Powered Retinal Screening & Clinical Insights
  </footer>

  <!-- Chart Initialization -->
  <script>
    const health = {{ stats.health | tojson }};
    const ctx = document.getElementById('healthChart').getContext('2d');
    new Chart(ctx, {
      type:'bar',
      data:{
        labels:health.labels,
        datasets:[{ label:'Model Confidence (%)', data:health.data,
          backgroundColor:[
            'rgba(0,180,216,0.8)','rgba(0,150,199,0.8)','rgba(0,119,182,0.8)','rgba(2,62,138,0.8)','rgba(3,4,94,0.8)'
          ],
          borderRadius:10, hoverBackgroundColor:'#48cae4'
        }]
      },
      options:{
        responsive:true,
        scales:{ y:{beginAtZero:true,max:100,ticks:{color:'#a5c9ff'},grid:{color:'rgba(255,255,255,0.05)'}},
                 x:{ticks:{color:'#cbeaff'},grid:{color:'rgba(255,255,255,0.05)'}} },
        plugins:{ legend:{display:false}, tooltip:{backgroundColor:'#023e8a',titleColor:'#fff',bodyColor:'#fff',borderWidth:1,borderColor:'#00b4d8'} }
      }
    });
  </script>

  <!-- ‚úÖ PWA Install Script -->
  <script>
    let deferredPrompt;
    const installCard = document.getElementById('install-card');
    const installBtn = document.getElementById('install-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installCard.classList.add('show');
    });

    installBtn.addEventListener('click', async () => {
      installCard.classList.remove('show');
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`‚úÖ User ${outcome} installation`);
      deferredPrompt = null;
    });

    window.addEventListener('appinstalled', () => {
      console.log("‚úÖ VisionAI installed successfully");
      installCard.classList.remove('show');
    });
  </script>

  <!-- Sidebar Monitor -->
  <div id="visionai-sidebar" class="collapsed">
    <div class="sidebar-header">
      <img src="{{ url_for('static', filename='visionai_logo.png') }}" alt="Logo">
      <span>VisionAI Monitor</span>
      <div id="sidebar-toggle" class="toggle-btn">‚öôÔ∏è</div>
    </div>
    <div class="sidebar-body">
      <div><b>CPU:</b> <span id="sidebar-cpu">--%</span></div>
      <div><b>RAM:</b> <span id="sidebar-ram">--%</span></div>
      <div><b>GPU:</b> <span id="sidebar-gpu">-- MB</span></div>
      <div><b>Temp:</b> <span id="sidebar-temp">--¬∞C</span></div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/sidebar_monitor.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
